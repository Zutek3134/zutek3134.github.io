<!DOCTYPE html>
<html lang="zh-tw">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>北捷交通王 — Zutek’s Secret Warehouse</title>
    <meta name="description" content="北捷交通王">
    <!-- <meta property="og:image" content="https://zutek3134.taipei/images/mrtProBanner.png"> -->
    <meta name="twitter:card" content="summary_large_image">
    <!-- <meta name="twitter:image" content="https://zutek3134.taipei/images/mrtProBanner.png"> -->

    <link rel="icon" type="image/x-icon" href="/images/zeeb.png">
    <!-- <link rel="alternate" hreflang="zh" href="https://zutek3134.taipei/zh-tw/lab/mrtPro/" /> -->
    <link href='/stylesheets/style.css' rel='stylesheet'>
    <link href='/stylesheets/mandarinSupport.css' rel='stylesheet'>
    <link href='/js/tabs/stylesheet.css' rel='stylesheet'>
    <link href='/js/details/stylesheet.css' rel='stylesheet'>
    <style>
        main {
            min-height: calc(100dvh - var(--nav-height));
        }

        .green {
            color: var(--success);
        }

        .red {
            color: var(--danger);
        }

        #settings>.item {
            display: flex;
        }

        #settings h3 {
            margin: var(--gap-half);
        }

        #settings input {
            margin: auto;
            min-width: 3em;
        }

        .guess {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(18em, 1fr));
            gap: 0.75em;
        }

        @keyframes slideIn {
            0% {
                opacity: 0;
                transform: translateX(-25%);
            }

            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        #guessAttempts .card {
            animation: slideIn 0.5s ease-out forwards;
        }

        .guess .card {
            font-size: 0.9em;
        }

        .guess .title {
            font-size: 1.2em;
        }

        .guess .title span {
            float: right;
            opacity: 0.3;
        }

        .guess .body {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            text-align: center;
        }

        .guess .body .smol-title {
            margin-bottom: 0.25em;
        }

        .guess .body .display {
            font-size: 2em;
            font-weight: bold;
        }

        .typeArea {
            position: relative;
            display: flex;
            justify-content: center;
        }

        .typeArea input {
            width: 100%;
            padding: var(--gap-half);
            background: var(--card-bg);
            font-size: 1.25rem;
        }

        .typeArea .submitBtn {
            --btn-theme: var(--card-bg);
            color: var(--color);
            border-width: 1px;
        }

        .typeArea .submitBtn:not([disabled]):hover {
            color: var(--bg);
        }

        .typeArea .submitBtn:focus {
            border-color: var(--border);
        }

        .typeArea input:disabled {
            background: var(--bg);
            border-color: var(--card-bg);
        }

        hr {
            margin-bottom: 1em;
        }

        .vr {
            border-left: 1px dashed var(--border);
            height: 2em;
        }

        .game-nav {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            padding: var(--gap-half);
            justify-content: center;
            align-items: center;
            gap: var(--gap-half);
        }

        .game-nav h1 {
            margin: 0;
        }

        .game-nav-actions {
            display: flex;
            flex-direction: row;
            justify-content: flex-end;
        }

        .game-nav-actions>a {
            padding: 0.5em 1em;
        }

        .game-nav-actions>a:hover {
            background-color: var(--card-bg);
        }

        .game-nav-actions #question {
            font-weight: 700;
        }

        .game-nav #led {
            width: 100%;
            height: 100%;
            background-color: var(--bg-dark);
            border-radius: var(--gap-half);
            position: relative;
            overflow: hidden;
        }

        .game-nav #led p {
            position: absolute;
            left: 100%;
            top: 25%;
            margin: 0;
            text-wrap: nowrap;
            transition: left 6s linear;
        }

        .game-nav #led p.enter {
            left: -100%;
        }

        #chances-label #alt {
            display: none;
        }

        #chances-label[data-mode="alt"] #normal {
            display: none;
        }

        #chances-label[data-mode="alt"] #alt {
            display: inline;
        }

        #score-skill::before {
            content: '安全係數';
        }

        #score-luck::before {
            content: '幸運指數';
        }

        .scoreArea::before {
            display: block;
            color: var(--primary);
            font-size: 0.7em;
            opacity: 0.7;
        }

        .scoreArea::after {
            content: '%';
            margin-left: 0.2em;
            font-size: 0.6em;
        }

        #wordleBotOutput sub {
            vertical-align: baseline;
            font-size: 0.7em;
            margin-left: 0.4em;
        }

        .wordleBotDetailsIcon {
            --alert-icon: url('data: image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13A2.5 2.5 0 0 0 5 15.5 2.5 2.5 0 0 0 7.5 18a2.5 2.5 0 0 0 2.5-2.5A2.5 2.5 0 0 0 7.5 13m9 0a2.5 2.5 0 0 0-2.5 2.5 2.5 2.5 0 0 0 2.5 2.5 2.5 2.5 0 0 0 2.5-2.5 2.5 2.5 0 0 0-2.5-2.5"></path></svg>');
        }

        @media only screen and (max-width: 600px) {
            .game-nav {
                grid-template-columns: 1fr;
            }

            .game-nav h1 {
                text-align: center;
            }

            .game-nav-actions {
                justify-content: center;
            }

            .game-nav #led {
                height: 2.5rem;
            }

            .game-nav #led p {
                top: 0.625rem;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@tsparticles/confetti@3.0.3/tsparticles.confetti.bundle.min.js"></script>
    <script src="/js/modal/script.js"></script>
</head>

<body>
    <nav id="nav-placeholder" data-qr="true"></nav>
    <div id="modal-gameSettings" class="modal" data-onclose="loadGame">
        <div class="content show">
            <div class="header">
                <span class="close" onclick="closeModal()"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M12 2c5.53 0 10 4.47 10 10s-4.47 10-10 10S2 17.53 2 12 6.47 2 12 2m3.59 5L12 10.59 8.41 7 7 8.41 10.59 12 7 15.59 8.41 17 12 13.41 15.59 17 17 15.59 13.41 12 17 8.41z"></path>
                        </svg></span></span>
                <h2>北捷交通王</h2>
            </div>
            <div class="body">
                <h2>壹、設定</h2>
                <div class="row mar-b-3" id="settings">
                    <div class="item">
                        <h3 class="text-nowrap">遊戲機會</h3>
                        <input type="number" id="maxAttempts" class="width-full" placeholder="預設：12" min="1" max="24" value="12">
                        <h3 class="text-nowrap">次</h3>
                    </div>
                    <label class="item-width">
                        <label class="switch-holder mar-l-05"><label class="switch">
                                <input type="checkbox" id="inputHint">
                                <span class="slider"></span>
                            </label>
                            <h3 class="switch-name">輸入建議</h3>
                        </label>
                    </label>
                    <div class="item-full">
                        <h3>路線範圍（<span id="chosenCount" class="hanLat hl-r">6</span>條）</h3>
                        <p style="margin: var(--gap-half);">目前僅支援「文湖線」、「淡水信義線」、「松山新店線」、「中和新蘆線」、「板南線」、「新北環狀線」。</p>
                    </div>
                </div>
                <h2>貳、玩法</h2>
                <div class="mar-b-3">
                    <p>每次答題時，會滑入新的卡片，上面顯示與目標車站之差異。</p>
                    <hr />
                    <div class="guess text-nowrap">
                        <div class="card">
                            <div class="title">中山<span>#1</span></div>
                            <div class="body">
                                <div class="item">
                                    <div class="smol-title">字數</div>
                                    <div class="display" title="多於"><span class="red">↑</span></div>
                                </div>
                                <div class="item">
                                    <div class="smol-title">轉乘</div>
                                    <div class="display"><span class="green">0</span></div>
                                </div>
                                <div class="item">
                                    <div class="smol-title">距離</div>
                                    <div class="display"><span class="red">4</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p>如上，由左而右分別為「字數差異」、「最少轉乘次數」、「最少車站距離」，可推得以下線索：</p>
                    <ol class="informal">
                        <li>目標車站<strong>大於</strong><span class="hanLat">2</span>字，因箭頭提示朝上；</li>
                        <li>目標車站位於「淡水信義線」或「松山新店線」，因「轉乘次數」為<span class="hanLat">0</span>次；</li>
                        <li>目標車站為本（中山）站始第<span class="hanLat">4</span>站。</li>
                    </ol>
                    <p>綜上，目標車站為「南京三民」，非「中正紀念堂」。</p>
                    <hr />
                    <details class="alert-warning expanded" open>
                        <summary>遊戲有以下較為反直覺之內容，煩請留意：</summary>
                        <ol class="informal">
                            <li>截至目前，臺北捷運系統內僅有<span class="hanLat">2</span>座站外轉乘車站，即「板橋」及「新埔／新埔民生」。車站名不同者，不列為轉乘車站。故「新埔」及「新埔民生」分別為兩座相異車站。</li>
                            <li>截至目前，臺北捷運系統內僅有<span class="hanLat">2</span>條支線，即「新北投」及「小碧潭」。因遊戲需顧及轉乘、距離，故將其自題庫中移除，避免影響計算。</li>
                            <li>「最少轉乘次數」與「最少車站距離」經分別獨立計算。如「西門」至「信義安和」最少只需轉乘<span class="hanLat">1</span>次，途經<span class="hanLat">6</span>座車站。但從文湖線轉乘<span class="hanLat">2</span>次時，僅需途經<span class="hanLat">5</span>座。</li>
                        </ol>
                    </details>
                </div>
                <h2>參、聲明</h2>
                <p class="indent">為什麼我要做這個東西？超爆難。日後可能會跟運斗一樣出個破關的ㄟㄞ，現在先靠自己跟地圖吧。本遊戲還非常非常新，歡迎提供意見。</p>
                <p class="indent">敬祝　遊戲愉快</p>
            </div>
            <div class="footer">
                <p class="text-centre">關閉此頁面後，直至下次遊戲前，皆不得再編輯。</p>
            </div>
        </div>
    </div>
    <main>
        <div class="container">
            <div class="game-nav">
                <h1>北捷交通王</span></h1>
                <div class="game-nav-actions">
                    <a href="/metro/" target="_blank">捷運小工具<span class="twemoji" style="font-size: 0.7em; margin: 0 0 0 0.3em; vertical-align: middle;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                <path d="M3.75 2h3.5a.75.75 0 0 1 0 1.5h-3.5a.25.25 0 0 0-.25.25v8.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-3.5a.75.75 0 0 1 1.5 0v3.5A1.75 1.75 0 0 1 12.25 14h-8.5A1.75 1.75 0 0 1 2 12.25v-8.5C2 2.784 2.784 2 3.75 2m6.854-1h4.146a.25.25 0 0 1 .25.25v4.146a.25.25 0 0 1-.427.177L13.03 4.03 9.28 7.78a.75.75 0 0 1-1.042-.018.75.75 0 0 1-.018-1.042l3.75-3.75-1.543-1.543A.25.25 0 0 1 10.604 1" />
                            </svg></span></a>
                    <div class="vr"></div>
                    <a id="chances-label" data-mode="normal" onclick="this.dataset.mode = this.dataset.mode === 'normal' ? 'alt' : 'normal'"><span id="normal">第 1 之 12 次</span><span id="alt">餘 11 次</span></a>
                    <div class="vr"></div>
                    <a id="question" onclick="openModal('gameSettings')">？</a>
                </div>
                <div id="led"></div>
                <div class="typeArea">
                    <input list="guessesList" type="text" id="inputField" placeholder="輸入車站名稱" style="border-radius: var(--gap-half) 0 0 var(--gap-half);">
                    <button class="btn btn-fill submitBtn" onclick="handleEnterButton()" style="border-radius: 0 var(--gap-half) var(--gap-half) 0;"><span class="twemoji" style="margin-right: 0.1em;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                <path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.8l167.6-182.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4" />
                            </svg></span></button>
                </div>
            </div>
            <hr>
            <div class="guess text-nowrap" id="guessAttempts">
                <!-- <div class="card">
                    <div class="title">車站名稱</div>
                    <div class="body">
                        <div class="item">
                            <div class="smol-title">字數</div>
                            <p class="display">少於</p>
                        </div>
                        <div class="item">
                            <div class="smol-title">路線</div>
                            <p class="display">相同</p>
                        </div>
                        <div class="item">
                            <div class="smol-title">轉乘</div>
                            <p class="display"><span class="hanLat hl-r">1</span>次</p>
                        </div>
                        <div class="item">
                            <div class="smol-title">距離</div>
                            <p class="display"><span class="hanLat hl-r">1</span>站</p>
                        </div>
                    </div> -->
            </div>
            <div id="gameOverTab" class="text-centre width-full mar-t-1 display-none">
                <div>
                    <!-- <button id="shareBtn" class="btn btn-fill" style="margin-right: var(--gap)" onclick="openModal('gameOverShare');"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                        <path d="m21 12-7-7v4C7 10 4 15 3 20c2.5-3.5 6-5.1 11-5.1V19z" />
                                    </svg></span>分享結果</button> -->
                    <button id="replayBtn" class="btn" onclick="location.reload();"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M12 4c2.1 0 4.1.8 5.6 2.3 3.1 3.1 3.1 8.2 0 11.3-1.8 1.9-4.3 2.6-6.7 2.3l.5-2c1.7.2 3.5-.4 4.8-1.7 2.3-2.3 2.3-6.1 0-8.5C15.1 6.6 13.5 6 12 6v4.6l-5-5 5-5zM6.3 17.6C3.7 15 3.3 11 5.1 7.9l1.5 1.5c-1.1 2.2-.7 5 1.2 6.8q.75.75 1.8 1.2l-.6 2q-1.5-.6-2.7-1.8" />
                            </svg></span>再玩一次</button>
                </div>
                <!-- <div class="table-container mar-t-1">
                    <table>
                        <tr>
                            <th style="width: 33%;">字數</th>
                            <th style="width: 33%;">機會</th>
                            <th style="width: 33%;">路線</th>
                        </tr>
                    </table>
                </div> -->
            </div>
        </div>
        <canvas id="gameCanvas" style="display: none;"></canvas>
        </div>
        <div class="container display-none">
            <div class="card">
                <div class="title">
                    <h3 class="mar-0 text-centre">作弊不可取</h3>
                </div>
                <div class=" body">
                    <!-- 請勿作弊，作弊可恥 -->
                    <p id="possibleSolutions" class="mar-0"></p>
                </div>
            </div>
        </div>
    </main>
    <footer id="footer-placeholder"></footer>
    <script src="/includes/includes.js" data-comments></script>
    <script src="/js/tabs/script.js"></script>
    <script src="/js/details/script.js"></script>
    <script src="/js/autocomplete/script.js"></script>
    <script>
        const ledHolder = document.getElementById('led');
        let ledTimers = [];
        let ledMsg;

        const replaceList = {
            "七哩岸": "唭哩岸",
            "廣慈奉天宮": "廣慈／奉天宮",
            "中坡": "廣慈／奉天宮",
            "林光": "麟光",
            "下安": "廈安",
            "高樓大廈安": "廈安",
            "夏安": "廈安",
            "新是一路": "新市一路",
            "海珊": "海山",
            "聯城錦和": "連城錦和",
            "聯成錦和": "連城錦和",
            "連成錦和": "連城錦和",
            "新店市公所": "新店區公所"
        };

        function showMessage(msg) {
            if (ledMsg) {
                ledTimers.forEach(timer => clearTimeout(timer));
                ledMsg.remove();
                ledMsg = null;
            }

            const newLedMsg = document.createElement('p');
            newLedMsg.innerHTML = msg;
            ledHolder.appendChild(newLedMsg);

            ledMsg = newLedMsg;

            ledTimers[0] = setTimeout(() => {
                ledMsg.classList.add('enter');

                ledTimers[1] = setTimeout(() => {
                    ledMsg.remove();
                    ledMsg = null;
                }, 6500);
            }, 100);
        }

        let stations = [];
        let wordList = [];
        const idMap = new Map();
        let target = null;
        let targetWord = null;
        let guesses = [];

        const labelChancesNormal = document.querySelector('#chances-label #normal');
        const labelChancesAlt = document.querySelector('#chances-label #alt');
        const inputField = document.getElementById('inputField');
        const submitBtn = document.querySelector('button.submitBtn');
        const guessAttempts = document.getElementById('guessAttempts');

        var handleEnterButton;

        const hints = {
            "等於": "<span class='green'>✓</span>",
            "少於": "<span class='red'>↓</span>",
            "多於": "<span class='red'>↑</span>"
        }

        function loadGame() {
            const gameSettingsModal = document.getElementById('modal-gameSettings');
            gameSettingsModal.removeAttribute('data-onclose');
            const formElements = gameSettingsModal.querySelectorAll('input, .btn');
            formElements.forEach(element => {
                element.disabled = true;
                element.classList.add('disabled');
            });

            target = stations[Math.floor(Math.random() * stations.length)];
            targetWord = target.name;
            console.log(targetWord);

            const maxAttempts = Math.min(Math.max(document.querySelector('#maxAttempts').value, 1), 24);
            console.log(maxAttempts);

            const enableHint = document.querySelector('#inputHint').checked;

            const settings = {
                maxAttempts,
                enableHint
            };
            localStorage.setItem('mrtProSettings', JSON.stringify(settings));

            if (enableHint) {
                let sortWordList = Array.from(wordList);
                sortWordList.sort((a, b) => {
                    if (a.length !== b.length) return a.length - b.length;
                    return a.localeCompare(b, 'zh-Hant');
                });
                setupAutocomplete(inputField, sortWordList);
            }

            function updateChances(cur) {
                labelChancesNormal.innerHTML = '第<span class="hanLat">' + cur + '</span>之<span class="hanLat">' + maxAttempts + '</span>次';
                labelChancesAlt.innerHTML = '餘<span class="hanLat">' + (maxAttempts - cur + 1) + '</span>次';
            }
            updateChances(1);

            inputField.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleEnter();
                }
            });

            function handleEnter() {
                let rawguess = inputField.value.trim()
                    .replaceAll(' ', '')
                    .replaceAll('/', '／')
                    .replaceAll('(', '（')
                    .replaceAll(')', '）')
                    .replaceAll('台', '臺')
                    .replaceAll('口其', '唭')
                    .replaceAll('但金', '淡金')
                    .replaceAll('虫內', '蚋')
                    .replaceAll('加辣', '加蚋');

                if (rawguess.length === 0) return;

                if (Object.keys(replaceList).includes(rawguess))
                    rawguess = replaceList[rawguess];

                const guess = rawguess;

                inputField.value = "";
                inputField.dispatchEvent(new Event("input"));

                if (['放棄', '投降', '答案', '不知道', '不曉得'].includes(guess)) {
                    showMessage(targetWord);
                    controlInputs(targetWord);
                    document.getElementById('wordleBotOutputContainer').classList.remove('display-none');
                    return;
                }
                else if (guesses.length > 0 && guesses[guesses.length - 1] === "龍山寺" && guess === "天后宮") {
                    showMessage("雕刻精美唐山公");
                    return;
                }

                if (!wordList.includes(guess)) {
                    showMessage("查無此站");
                    return;
                }

                if (guesses.includes(guess)) {
                    showMessage("本站已被猜過");
                    return;
                }

                guesses.push(guess);

                const guessObj = idMap.get(guess);
                inputField.value = null;

                // compute hints
                const wcGuess = wordCount(guessObj.name);
                const wcTarget = wordCount(target.name);
                const wcHint = ((wcGuess === wcTarget) ? '等' : (wcGuess > wcTarget ? '少' : '多')) + '於';
                const dist = minStationsBetween(guessObj, target);
                const transfers = minTransfers(guessObj, target);

                // add history
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<div class="title">${guessObj.name}<span>#${guesses.length}</span></div>
                    <div class="body">
                        <div class="item">
                            <div class="smol-title">字數</div>
                            <div class="display" title="${wcHint}">${hints[wcHint]}</div>
                        </div>
                        <div class="item">
                            <div class="smol-title">轉乘</div>
                            <div class="display"><span class="${transfers === 0 ? "green" : "red"}">${transfers}</span></div>
                        </div>
                        <div class="item">
                            <div class="smol-title">距離</div>
                            <div class="display"><span class="${dist === 0 ? "green" : "red"}">${dist === Infinity ? '∞' : dist}</span></div>
                        </div>
                    </div>`;

                guessAttempts.prepend(card);

                inputField.focus();

                if (guessObj.name === target.name) {
                    setTimeout(() => {
                        loadConfetti();
                    }, 300);
                    controlInputs(targetWord);

                    return;
                }

                updateChances(guesses.length + 1);

                if (guesses.length + 1 >= maxAttempts) {
                    showMessage(targetWord);
                    controlInputs(targetWord);
                    document.getElementById('wordleBotOutputContainer').classList.remove('display-none');
                    return;
                }
            }
            handleEnterButton = handleEnter;

            function controlInputs(innerText = "") {
                inputField.placeholder = innerText;
                inputField.disabled = true;
                submitBtn.disabled = true;

                const chancesUsed = guesses.length + 1 > maxAttempts ? 'X' : guesses.length + 1;
                const chancesLeft = guesses.length + 1 > maxAttempts ? 'X' : maxAttempts - chancesUsed;

                labelChancesNormal.innerHTML = `第<span class="hanLat">${chancesUsed}</span>之<span class="hanLat">${maxAttempts}</span>次`;
                labelChancesAlt.innerHTML = '餘<span class="hanLat">' + chancesLeft + '</span>次';

                document.querySelector('#gameOverTab').classList.remove('display-none');
            }

            function loadConfetti() {
                if ((guesses.length + 1) <= 6) {
                    const end = Date.now() + 2 * 1000;

                    (function frame() {
                        confetti({
                            particleCount: 2,
                            angle: randomInRange(50, 70),
                            spread: randomInRange(50, 60),
                            origin: { x: 0, y: randomInRange(0.4, 0.6) },
                        });

                        confetti({
                            particleCount: 2,
                            angle: randomInRange(110, 130),
                            spread: randomInRange(50, 60),
                            origin: { x: 1, y: randomInRange(0.4, 0.6) },
                        });

                        if (Date.now() < end) {
                            requestAnimationFrame(frame);
                        }
                    })();
                } else if ((guesses.length + 1) <= 10) {
                    const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

                    confetti(
                        Object.assign({}, defaults, {
                            particleCount: 50,
                            origin: { x: randomInRange(0.1, 0.3), y: randomInRange(0.6, 0.8) },
                        })
                    );
                    confetti(
                        Object.assign({}, defaults, {
                            particleCount: 50,
                            origin: { x: randomInRange(0.7, 0.9), y: randomInRange(0.6, 0.8) },
                        })
                    );
                    confetti(
                        Object.assign({}, defaults, {
                            particleCount: 100,
                            origin: { x: randomInRange(0, 0.2), y: randomInRange(0.1, 0.3) },
                        })
                    );
                    confetti(
                        Object.assign({}, defaults, {
                            particleCount: 100,
                            origin: { x: randomInRange(0.8, 1), y: randomInRange(0.1, 0.3) },
                        })
                    );
                } else {
                    confetti({
                        angle: 270,
                        spread: 400,
                        particleCount: 150,
                        origin: { x: 0.5, y: 0 },
                    });
                }
            }
        }

        function wordCount(name) {
            return name.split("").filter(Boolean).length;
        }

        // function onSameLine(a, b) {
        //     return a.lines.some(l => b.lines.includes(l));
        // }

        function minStationsBetween(a, b) {
            if (a.name === b.name) return 0;
            const queue = [a.name];
            const dist = { [a.name]: 0 };
            while (queue.length) {
                const cur = queue.shift();
                const d = dist[cur];
                for (const nb of idMap.get(cur).neighbors) {
                    if (!(nb in dist)) {
                        dist[nb] = d + 1;
                        if (nb === b.name) return dist[nb];
                        queue.push(nb);
                    }
                }
            }
            return Infinity;
        }

        function minTransfers(a, b) {
            if (a.name === b.name) return 0;
            const pq = [];
            const seen = new Map();
            a.lines.forEach(line => {
                pq.push({ station: a.name, line, transfers: 0 });
                seen.set(a.name + '|' + line, 0);
            });

            while (pq.length) {
                pq.sort((x, y) => x.transfers - y.transfers);
                const cur = pq.shift();
                if (cur.station === b.name) return cur.transfers;
                const curObj = idMap.get(cur.station);

                // move along same line
                curObj.neighbors.forEach(nb => {
                    const nbObj = idMap.get(nb);
                    if (nbObj.lines.includes(cur.line)) {
                        const key = nb + '|' + cur.line;
                        if (!seen.has(key) || seen.get(key) > cur.transfers) {
                            seen.set(key, cur.transfers);
                            pq.push({ station: nb, line: cur.line, transfers: cur.transfers });
                        }
                    }
                });

                // transfer
                curObj.lines.forEach(line2 => {
                    if (line2 !== cur.line) {
                        const key = cur.station + '|' + line2;
                        if (!seen.has(key) || seen.get(key) > cur.transfers + 1) {
                            seen.set(key, cur.transfers + 1);
                            pq.push({ station: cur.station, line: line2, transfers: cur.transfers + 1 });
                        }
                    }
                });
            }
            return Infinity;
        }

        function loadData(data) {
            const temp = {};
            for (const [lineId, stops] of Object.entries(data.lines)) {
                stops.forEach((name, i) => {
                    if (!temp[name]) temp[name] = { name, lines: new Set(), neighbors: new Set() };
                    temp[name].lines.add(lineId);
                    if (i > 0) {
                        const prev = stops[i - 1];
                        temp[name].neighbors.add(prev);
                        temp[prev].neighbors.add(name);
                    }
                });
            }

            stations = Object.values(temp).map(s => ({
                name: s.name,
                lines: Array.from(s.lines),
                neighbors: Array.from(s.neighbors)
            }));

            stations.forEach(s => idMap.set(s.name, s));
            wordList = stations.map(s => s.name).sort((a, b) => a.localeCompare(b, 'zh-Hant'));

            const savedSettings = localStorage.getItem('mrtProSettings');
            if (savedSettings) {
                const {
                    maxAttempts,
                    enableHint
                } = JSON.parse(savedSettings);

                document.querySelector('#maxAttempts').value = Math.min(Math.max(maxAttempts, 1), 24);
                document.querySelector('#inputHint').checked = enableHint;
            }

            openModal('gameSettings');
        }

        fetch('data.json').then(r => r.json()).then(data => { loadData(data); }).catch(e => console.error(e));
    </script>
</body>

</html>